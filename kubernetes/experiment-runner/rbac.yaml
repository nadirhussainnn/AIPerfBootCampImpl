# ServiceAccount and RBAC for the experiment runner.
# The runner creates namespaces, deploys apps (Deployments, Services, Istio resources),
# scales deployments, and port-forwards to Prometheus.
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: experiment-runner
  namespace: experiment-runner
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: experiment-runner
rules:
  # Create/delete experiment namespaces and label them
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["create", "delete", "get", "list", "patch", "watch"]
  # Deployments: apply app YAML, rollout status, scale (replicas)
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  # Scale subresource (kubectl scale patches deployments/scale)
  - apiGroups: ["apps"]
    resources: ["deployments/scale"]
    verbs: ["get", "patch", "update"]
  # Services and Pods (for apply and port-forward)
  - apiGroups: [""]
    resources: ["services", "pods", "pods/portforward"]
    verbs: ["create", "delete", "get", "list", "patch", "watch"]
  # Istio: Gateway, VirtualService, DestinationRule
  - apiGroups: ["networking.istio.io"]
    resources: ["gateways", "virtualservices", "destinationrules"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  # HPA if you use HPA autoscaler
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: experiment-runner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: experiment-runner
subjects:
  - kind: ServiceAccount
    name: experiment-runner
    namespace: experiment-runner
